<!DOCTYPE html>
<html prefix="og: http://ogp.me/ns# article: http://ogp.me/ns/article# " lang="en">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>Decision curve anaysis (决策曲线分析) | 深度识医</title>
<link href="../assets/css/all-nocdn.css" rel="stylesheet" type="text/css">
<meta name="theme-color" content="#5670d4">
<meta name="generator" content="Nikola (getnikola.com)">
<link rel="alternate" type="application/rss+xml" title="RSS" href="../rss.xml">
<link rel="canonical" href="https://lengyueyang.github.io/Research/decision-curve-anaysis.html">
<!--[if lt IE 9]><script src="../assets/js/html5.js"></script><![endif]--><meta name="author" content="Lengyueyang">
<link rel="prev" href="Nomogram-rms.html" title="Nomograph 图制作 (一) - 用 rms 绘制 nomogram" type="text/html">
<link rel="next" href="../Life/gentoo-install.html" title="Gentoo 系统 - (一) 系统配置与安装" type="text/html">
<meta property="og:site_name" content="深度识医">
<meta property="og:title" content="Decision curve anaysis (决策曲线分析)">
<meta property="og:url" content="https://lengyueyang.github.io/Research/decision-curve-anaysis.html">
<meta property="og:description" content="Table of Contents


决策曲线概述
Rmda 软件包使用

Getting started
Alternative plotting functions
The net benefit of an ‘opt-out’ vs. ‘opt-in’ policy
Tweaking the defaults
Providing fitted risks from a previously">
<meta property="og:type" content="article">
<meta property="article:published_time" content="2018-02-04T09:56:36+08:00">
<meta property="article:tag" content="DCA">
</head>
<body>
<a href="#content" class="sr-only sr-only-focusable">Skip to main content</a>

<!-- Menubar -->

<nav class="navbar navbar-inverse navbar-static-top"><div class="container">
<!-- This keeps the margins nice -->
        <div class="navbar-header">
            <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#bs-navbar" aria-controls="bs-navbar" aria-expanded="false">
            <span class="sr-only">Toggle navigation</span>
            <span class="icon-bar"></span>
            <span class="icon-bar"></span>
            <span class="icon-bar"></span>
            </button>
            <a class="navbar-brand" href="https://lengyueyang.github.io/">

                <span id="blog-title">深度识医</span>
            </a>
        </div>
<!-- /.navbar-header -->
        <div class="collapse navbar-collapse" id="bs-navbar" aria-expanded="false">
            <ul class="nav navbar-nav">
<li>
<a href="../posts/data-science/index.html">Data Science</a>
                </li>
<li>
<a href="../posts/research/index.html">Research</a>
                </li>
<li>
<a href="../posts/life/index.html">Life</a>
                </li>
<li>
<a href="../categories/index.html">Tags</a>
                </li>
<li>
<a href="../archive.html">Archives</a>
                </li>
<li>
<a href="../pages/notes.html">Notes</a>
                </li>
<li>
<a href="../pages/links.html">Links</a>
                </li>
<li>
<a href="../pages/about.html">About</a>
                </li>
<li>
<a href="https://github.com/lengyueyang">Github</a>
                </li>
<li>
<a href="../rss.xml">RSS feed</a>

                
            </li>
</ul>
<!-- Google custom search --><form method="get" action="https://www.google.com/search" class="navbar-form navbar-right" role="search">
<div class="form-group">
<input type="text" name="q" class="form-control" placeholder="Search">
</div>
<button type="submit" class="btn btn-primary">
	<span class="glyphicon glyphicon-search"></span>
</button>
<input type="hidden" name="sitesearch" value="https://lengyueyang.github.io/">
</form>
<!-- End of custom search -->


            <ul class="nav navbar-nav navbar-right"></ul>
</div>
<!-- /.navbar-collapse -->
    </div>
<!-- /.container -->
</nav><!-- End of Menubar --><div class="container" id="content" role="main">
    <div class="body-content">
        <!--Body content-->
        <div class="row">
            
            
<article class="post-text h-entry hentry postpage" itemscope="itemscope" itemtype="http://schema.org/Article"><header><h1 class="p-name entry-title" itemprop="headline name"><a href="#" class="u-url">Decision curve anaysis (决策曲线分析)</a></h1>

        <div class="metadata">
            <p class="byline author vcard"><span class="byline-name fn" itemprop="author">
                    Lengyueyang
            </span></p>
            <p class="dateline"><a href="#" rel="bookmark"><time class="published dt-published" datetime="2018-02-04T09:56:36+08:00" itemprop="datePublished" title="2018-02-04 09:56">2018-02-04 09:56</time></a></p>
                <p class="commentline">
        
    <a href="decision-curve-anaysis.html#disqus_thread" data-disqus-identifier="cache/posts/Research/decision-curve-anaysis.html">Comments</a>


            

        </p>
</div>
        

    </header><div class="e-content entry-content" itemprop="articleBody text">
    <div id="table-of-contents">
<h2>Table of Contents</h2>
<div id="text-table-of-contents">
<ul>
<li><a href="decision-curve-anaysis.html#sec-1">决策曲线概述</a></li>
<li>
<a href="decision-curve-anaysis.html#sec-2">Rmda 软件包使用</a>
<ul>
<li><a href="decision-curve-anaysis.html#sec-2-1">Getting started</a></li>
<li><a href="decision-curve-anaysis.html#sec-2-2">Alternative plotting functions</a></li>
<li><a href="decision-curve-anaysis.html#sec-2-3">The net benefit of an ‘opt-out’ vs. ‘opt-in’ policy</a></li>
<li><a href="decision-curve-anaysis.html#sec-2-4">Tweaking the defaults</a></li>
<li><a href="decision-curve-anaysis.html#sec-2-5">Providing fitted risks from a previously specified model</a></li>
<li><a href="decision-curve-anaysis.html#sec-2-6">Printing estimates</a></li>
<li><a href="decision-curve-anaysis.html#sec-2-7">Case-control data</a></li>
<li><a href="decision-curve-anaysis.html#sec-2-8">Cross-validation</a></li>
</ul>
</li>
<li>
<a href="decision-curve-anaysis.html#sec-3">decisioncurveanalysis.org</a>
<ul>
<li>
<a href="decision-curve-anaysis.html#sec-3-1">Decision Curve Analysis for Binary Outcomes</a>
<ul>
<li><a href="decision-curve-anaysis.html#sec-3-1-1">Basic Data Set-up</a></li>
<li><a href="decision-curve-anaysis.html#sec-3-1-2">Univariate Decision Curve Analysis</a></li>
<li><a href="decision-curve-anaysis.html#sec-3-1-3">Multivariable Decision Curve Analysis</a></li>
</ul>
</li>
<li><a href="decision-curve-anaysis.html#sec-3-2">Decision Curve Analysis for Survival Outcomes</a></li>
<li><a href="decision-curve-anaysis.html#sec-3-3">Assessing Clinical Utility in a Case-Control Design</a></li>
</ul>
</li>
<li><a href="decision-curve-anaysis.html#sec-4">Creative Commons licensing</a></li>
</ul>
</div>
</div>


<div id="outline-container-sec-1" class="outline-2">
<h2 id="sec-1">决策曲线概述</h2>
<div class="outline-text-2" id="text-1">
<p>
决策曲线分析最近常用于评价临床决策的好坏, 比如建立一个模型后, 我们需要评价这个模型到底会不会被用于临床决策支持, 这时可以用这个决策分析曲线去评价.
</p>
<!-- TEASER_END -->

<p>
<code>R</code> 语言的 <code>rmda</code> 包可以用于画决策曲线, 同时 <code>decisioncurveanalysis.org</code> 网站也有现成的代码用于构建 DCA 分析, 本博客对这两种方法进行实践.
</p>

<p>
有关决策曲线的理论可以详见文章 Decision Curve Analysis(DOI: 10.1177/0272989X06295361).
</p>
</div>
</div>

<div id="outline-container-sec-2" class="outline-2">
<h2 id="sec-2">Rmda 软件包使用</h2>
<div class="outline-text-2" id="text-2">
<p>
Key functions in <code>rmda</code> are:
</p>

<p>
decision<sub>curve</sub>: Estimate (standardized) net benefit curves with bootstrap confidence intervals.
</p>

<p>
plot<sub>decision</sub><sub>curve</sub>: Plot a decision curve or multiple curves.
</p>

<p>
plot<sub>clinical</sub><sub>impact</sub> and plot<sub>roc</sub><sub>components</sub>: Alternative plots for the output of decision<sub>curve</sub> showing measures of clinical impact or the components of the ROC curve (true/false positive rates) across a range of risk thresholds. See help files or tutorial for more info.
</p>

<p>
cv<sub>decision</sub><sub>curve</sub>: Calculate k-fold cross-validated estimates of a decision curve and its components.
</p>


<p>
rmda 软件包自带样例数据, 按照官网的教程走一遍
</p>
</div>

<div id="outline-container-sec-2-1" class="outline-3">
<h3 id="sec-2-1">Getting started</h3>
<div class="outline-text-3" id="text-2-1">
<div class="highlight"><pre><span></span><span class="kn">library</span><span class="p">(</span>rmda<span class="p">)</span>
data<span class="p">(</span>dcaData<span class="p">)</span>
<span class="kp">head</span><span class="p">(</span>dcaData<span class="p">)</span>
</pre></div>

<pre class="example">
# A tibble: 6 x 6
    Age Female Smokes Marker1  Marker2 Cancer
  &lt;int&gt;  &lt;dbl&gt; &lt;lgl&gt;    &lt;dbl&gt;    &lt;dbl&gt;  &lt;int&gt;
1    33   1.00 F        0.245  1.02         0
2    29   1.00 F        0.943 -0.256        0
3    28   1.00 F        0.774  0.332        0
4    27   0    F        0.406 -0.00569      0
5    23   1.00 F        0.508  0.208        0
6    35   1.00 F        0.186  1.41         0
</pre>

<p>
First we use the function decision<sub>curve</sub> to create a decision curve object for a logistic model to predict cancer status using age, gender and smoking status. We then plot it using plot<sub>decision</sub><sub>curve</sub>.
</p>

<div class="highlight"><pre><span></span><span class="kp">set.seed</span><span class="p">(</span><span class="m">123</span><span class="p">)</span>
baseline.model <span class="o">&lt;-</span> decision_curve<span class="p">(</span>Cancer<span class="o">~</span>Age <span class="o">+</span> Female <span class="o">+</span> Smokes<span class="p">,</span> <span class="c1">#fitting a logistic model</span>
				data <span class="o">=</span> dcaData<span class="p">,</span> 
				study.design <span class="o">=</span> <span class="s">"cohort"</span><span class="p">,</span> 
				policy <span class="o">=</span> <span class="s">"opt-in"</span><span class="p">,</span>  <span class="c1">#default </span>
				bootstraps <span class="o">=</span> <span class="m">50</span><span class="p">)</span>

plot_decision_curve<span class="p">(</span>baseline.model<span class="p">,</span>  curve.names <span class="o">=</span> <span class="s">"baseline model"</span><span class="p">)</span>
</pre></div>


<div class="figure">
<p><img src="img/dca-rmda-1.png" alt="dca-rmda-1.png"></p>
</div>

<p>
Next, we create a decision curve with two markers added to the original baseline model. We then pass a list with both decision curves to plot<sub>decision</sub><sub>curve</sub> to plot both curves.
</p>

<div class="highlight"><pre><span></span><span class="kp">set.seed</span><span class="p">(</span><span class="m">123</span><span class="p">)</span>
full.model <span class="o">&lt;-</span> decision_curve<span class="p">(</span>Cancer<span class="o">~</span>Age <span class="o">+</span> Female <span class="o">+</span> Smokes <span class="o">+</span> Marker1 <span class="o">+</span> Marker2<span class="p">,</span>
	      data <span class="o">=</span> dcaData<span class="p">,</span> 
	      bootstraps <span class="o">=</span> <span class="m">50</span><span class="p">)</span>

<span class="c1">#since we want to plot more than one curve, we pass a list of 'decision_curve' objects to the plot</span>
plot_decision_curve<span class="p">(</span> <span class="kt">list</span><span class="p">(</span>baseline.model<span class="p">,</span> full.model<span class="p">),</span> 
		   curve.names <span class="o">=</span> <span class="kt">c</span><span class="p">(</span><span class="s">"Baseline model"</span><span class="p">,</span> <span class="s">"Full model"</span><span class="p">),</span> xlim <span class="o">=</span> <span class="kt">c</span><span class="p">(</span><span class="m">0</span><span class="p">,</span> <span class="m">1</span><span class="p">),</span> legend.position <span class="o">=</span> <span class="s">"bottomright"</span><span class="p">)</span> 
</pre></div>


<div class="figure">
<p><img src="img/dca-rmda-2.png" alt="dca-rmda-2.png"></p>
</div>
</div>
</div>

<div id="outline-container-sec-2-2" class="outline-3">
<h3 id="sec-2-2">Alternative plotting functions</h3>
<div class="outline-text-3" id="text-2-2">
<p>
We include two other functions plot<sub>roc</sub><sub>components</sub> and plot<sub>clinical</sub><sub>impact</sub>.
</p>

<p>
plot<sub>roc</sub><sub>components</sub> plots the components of the ROC curve-true positive rate and false positive rates-over a range of high risk thresholds.
</p>

<p>
If we were to use the specified model to classify 1,000 hypothetical subjects, plot<sub>clinical</sub><sub>impact</sub> plots the number classified as high risk and the number with the outcome classified as high risk for a given high risk threshold.
</p>

<div class="highlight"><pre><span></span>plot_roc_components<span class="p">(</span>full.model<span class="p">,</span>  xlim <span class="o">=</span> <span class="kt">c</span><span class="p">(</span><span class="m">0</span><span class="p">,</span> <span class="m">0.4</span><span class="p">),</span> 
		    col <span class="o">=</span> <span class="kt">c</span><span class="p">(</span><span class="s">"black"</span><span class="p">,</span> <span class="s">"red"</span><span class="p">))</span>
</pre></div>


<div class="figure">
<p><img src="img/dca-rmda-3.png" alt="dca-rmda-3.png"></p>
</div>

<div class="highlight"><pre><span></span><span class="c1">#plot the clinical impact </span>
plot_clinical_impact<span class="p">(</span>full.model<span class="p">,</span> xlim <span class="o">=</span> <span class="kt">c</span><span class="p">(</span><span class="m">0</span><span class="p">,</span> <span class="m">.4</span><span class="p">),</span> 
		     col <span class="o">=</span> <span class="kt">c</span><span class="p">(</span><span class="s">"black"</span><span class="p">,</span> <span class="s">"blue"</span><span class="p">))</span>
</pre></div>


<div class="figure">
<p><img src="img/dca-rmda-4.png" alt="dca-rmda-4.png"></p>
</div>
</div>
</div>

<div id="outline-container-sec-2-3" class="outline-3">
<h3 id="sec-2-3">The net benefit of an ‘opt-out’ vs. ‘opt-in’ policy</h3>
<div class="outline-text-3" id="text-2-3">

<div class="figure">
<p><img src="img/Statistic%20analysis/screenshot_2018-02-03_21-33-15.png" alt="screenshot_2018-02-03_21-33-15.png"></p>
</div>


<div class="figure">
<p><img src="img/Statistic%20analysis/screenshot_2018-02-03_21-33-34.png" alt="screenshot_2018-02-03_21-33-34.png"></p>
</div>

<div class="highlight"><pre><span></span><span class="kp">set.seed</span><span class="p">(</span><span class="m">123</span><span class="p">)</span>
opt.out.dc <span class="o">&lt;-</span> decision_curve<span class="p">(</span>Cancer<span class="o">~</span>Age <span class="o">+</span> Female <span class="o">+</span> Smokes <span class="o">+</span> Marker1 <span class="o">+</span> Marker2<span class="p">,</span>
	      data <span class="o">=</span> dcaData<span class="p">,</span> 
	      bootstraps <span class="o">=</span> <span class="m">50</span><span class="p">,</span> 
	      policy <span class="o">=</span> <span class="s">'opt-out'</span><span class="p">)</span> <span class="c1">#set policy = 'opt-out' (default is 'opt-in')</span>


plot_decision_curve<span class="p">(</span> opt.out.dc<span class="p">,</span>  xlim <span class="o">=</span> <span class="kt">c</span><span class="p">(</span><span class="m">0</span><span class="p">,</span> <span class="m">1</span><span class="p">),</span>
		     curve.names <span class="o">=</span> <span class="s">"model"</span><span class="p">,</span> legend <span class="o">=</span> <span class="s">'bottomright'</span><span class="p">)</span> 
</pre></div>


<div class="figure">
<p><img src="img/dca-rmda-5.png" alt="dca-rmda-5.png"></p>
</div>

<p>
The clinical impact plots are also influenced by the policy argument. When we set policy = ‘opt-out’ the clinical impact plot displays the number low risk instead of the number high risk.
</p>

<div class="highlight"><pre><span></span>plot_clinical_impact<span class="p">(</span> opt.out.dc<span class="p">,</span> col <span class="o">=</span> <span class="kt">c</span><span class="p">(</span><span class="s">"black"</span><span class="p">,</span> <span class="s">"blue"</span><span class="p">),</span> legend <span class="o">=</span> <span class="s">'bottomright'</span><span class="p">)</span>
</pre></div>


<div class="figure">
<p><img src="img/dca-rmda-6.png" alt="dca-rmda-6.png"></p>
</div>
</div>
</div>

<div id="outline-container-sec-2-4" class="outline-3">
<h3 id="sec-2-4">Tweaking the defaults</h3>
<div class="outline-text-3" id="text-2-4">
<p>
We show several examples of how one might change the default settings.
</p>

<p>
Fine tune the thresholds, move the legend, and change linewidth and colors. Here we are calculating many more points on the curve (see the ‘thresholds’ setting).
</p>

<div class="highlight"><pre><span></span>baseline.model <span class="o">&lt;-</span> decision_curve<span class="p">(</span>Cancer<span class="o">~</span>Age <span class="o">+</span> Female <span class="o">+</span> Smokes<span class="p">,</span>
				data <span class="o">=</span> dcaData<span class="p">,</span> 
				 thresholds <span class="o">=</span> <span class="kp">seq</span><span class="p">(</span><span class="m">0</span><span class="p">,</span> <span class="m">.4</span><span class="p">,</span> by <span class="o">=</span> <span class="m">.001</span><span class="p">),</span><span class="c1"># calculate thresholds from 0-0.4 at every 0.001 increment. </span>
				bootstraps <span class="o">=</span> <span class="m">25</span><span class="p">)</span>

full.model <span class="o">&lt;-</span> decision_curve<span class="p">(</span>Cancer<span class="o">~</span>Age <span class="o">+</span> Female <span class="o">+</span> Smokes <span class="o">+</span> Marker1 <span class="o">+</span> Marker2<span class="p">,</span>
			    data <span class="o">=</span> dcaData<span class="p">,</span> 
			    thresholds <span class="o">=</span> <span class="kp">seq</span><span class="p">(</span><span class="m">0</span><span class="p">,</span> <span class="m">.4</span><span class="p">,</span> by <span class="o">=</span> <span class="m">.001</span><span class="p">),</span><span class="c1"># calculate thresholds from 0-0.4 at every 0.001 increment. </span>
			    bootstraps <span class="o">=</span> <span class="m">25</span><span class="p">)</span>


plot_decision_curve<span class="p">(</span> <span class="kt">list</span><span class="p">(</span>baseline.model<span class="p">,</span> full.model<span class="p">),</span> 
		   curve.names <span class="o">=</span> <span class="kt">c</span><span class="p">(</span><span class="s">"Baseline model"</span><span class="p">,</span> <span class="s">"Full model"</span><span class="p">),</span>
		   col <span class="o">=</span> <span class="kt">c</span><span class="p">(</span><span class="s">"blue"</span><span class="p">,</span> <span class="s">"red"</span><span class="p">),</span> 
		   lty <span class="o">=</span> <span class="kt">c</span><span class="p">(</span><span class="m">1</span><span class="p">,</span><span class="m">2</span><span class="p">),</span> 
		   lwd <span class="o">=</span> <span class="kt">c</span><span class="p">(</span><span class="m">3</span><span class="p">,</span><span class="m">2</span><span class="p">,</span> <span class="m">2</span><span class="p">,</span> <span class="m">1</span><span class="p">),</span>  <span class="c1"># the first two correspond to the decision curves, then 'all' and then 'none' </span>
		   legend.position <span class="o">=</span> <span class="s">"bottomright"</span><span class="p">)</span> <span class="c1">#adjust the legend position</span>
</pre></div>


<div class="figure">
<p><img src="img/dca-rmda-7.png" alt="dca-rmda-7.png"></p>
</div>

<p>
Print specific cost:benefit ratios.
</p>
<div class="highlight"><pre><span></span>plot_decision_curve<span class="p">(</span> <span class="kt">list</span><span class="p">(</span>baseline.model<span class="p">,</span> full.model<span class="p">),</span> 
		   curve.names <span class="o">=</span> <span class="kt">c</span><span class="p">(</span><span class="s">"Baseline model"</span><span class="p">,</span> <span class="s">"Full model"</span><span class="p">),</span>
		   col <span class="o">=</span> <span class="kt">c</span><span class="p">(</span><span class="s">"blue"</span><span class="p">,</span> <span class="s">"red"</span><span class="p">),</span> 
		   confidence.intervals <span class="o">=</span> <span class="kc">FALSE</span><span class="p">,</span>  <span class="c1">#remove confidence intervals</span>
		   cost.benefit.axis <span class="o">=</span> <span class="kc">FALSE</span><span class="p">,</span> <span class="c1">#remove cost benefit axis</span>
		   legend.position <span class="o">=</span> <span class="s">"none"</span><span class="p">)</span> <span class="c1">#remove the legend </span>
</pre></div>


<div class="figure">
<p><img src="img/dca-rmda-8.png" alt="dca-rmda-8.png"></p>
</div>

<p>
Print specific cost:benefit ratios.
</p>
<div class="highlight"><pre><span></span>plot_decision_curve<span class="p">(</span> <span class="kt">list</span><span class="p">(</span>baseline.model<span class="p">,</span> full.model<span class="p">),</span> 
		   curve.names <span class="o">=</span> <span class="kt">c</span><span class="p">(</span><span class="s">"Baseline model"</span><span class="p">,</span> <span class="s">"Full model"</span><span class="p">),</span>
		   col <span class="o">=</span> <span class="kt">c</span><span class="p">(</span><span class="s">"blue"</span><span class="p">,</span> <span class="s">"red"</span><span class="p">),</span> 
		  cost.benefits <span class="o">=</span> <span class="kt">c</span><span class="p">(</span><span class="s">"1:1000"</span><span class="p">,</span> <span class="s">"1:4"</span><span class="p">,</span> <span class="s">"1:9"</span><span class="p">,</span> <span class="s">"2:3"</span><span class="p">,</span> <span class="s">"1:3"</span><span class="p">),</span>  <span class="c1">#set specific cost benefits</span>
		   legend.position <span class="o">=</span> <span class="s">"bottomright"</span><span class="p">)</span> 
</pre></div>


<div class="figure">
<p><img src="img/dca-rmda-9.png" alt="dca-rmda-9.png"></p>
</div>

<p>
Plot net benefit instead of standardize net benefit, change confidence interval level.
</p>
<div class="highlight"><pre><span></span>baseline.model <span class="o">&lt;-</span> decision_curve<span class="p">(</span>Cancer<span class="o">~</span>Age <span class="o">+</span> Female <span class="o">+</span> Smokes<span class="p">,</span>
				data <span class="o">=</span> dcaData<span class="p">,</span> 
				thresholds <span class="o">=</span> <span class="kp">seq</span><span class="p">(</span><span class="m">0</span><span class="p">,</span> <span class="m">.4</span><span class="p">,</span> by <span class="o">=</span> <span class="m">.01</span><span class="p">),</span>
				confidence.intervals <span class="o">=</span> <span class="m">0.9</span><span class="p">,</span> <span class="c1">#calculate 90% confidence intervals</span>
				bootstraps <span class="o">=</span> <span class="m">25</span><span class="p">)</span>

full.model <span class="o">&lt;-</span> decision_curve<span class="p">(</span>Cancer<span class="o">~</span>Age <span class="o">+</span> Female <span class="o">+</span> Smokes <span class="o">+</span> Marker1 <span class="o">+</span> Marker2<span class="p">,</span>
			    data <span class="o">=</span> dcaData<span class="p">,</span> 
			    thresholds <span class="o">=</span> <span class="kp">seq</span><span class="p">(</span><span class="m">0</span><span class="p">,</span> <span class="m">.40</span><span class="p">,</span> by <span class="o">=</span> <span class="m">.01</span><span class="p">),</span>
			    confidence.intervals <span class="o">=</span> <span class="m">0.9</span><span class="p">,</span> <span class="c1">#calculate 90% confidence intervals</span>
			    bootstraps <span class="o">=</span> <span class="m">25</span><span class="p">)</span>

plot_decision_curve<span class="p">(</span> <span class="kt">list</span><span class="p">(</span>baseline.model<span class="p">,</span> full.model<span class="p">),</span> 
		   curve.names <span class="o">=</span> <span class="kt">c</span><span class="p">(</span><span class="s">"Baseline model"</span><span class="p">,</span> <span class="s">"Full model"</span><span class="p">),</span>
		   col <span class="o">=</span> <span class="kt">c</span><span class="p">(</span><span class="s">"blue"</span><span class="p">,</span> <span class="s">"red"</span><span class="p">),</span> 
		   ylim <span class="o">=</span> <span class="kt">c</span><span class="p">(</span><span class="m">-0.05</span><span class="p">,</span> <span class="m">0.15</span><span class="p">),</span> <span class="c1">#set ylim</span>
		   lty <span class="o">=</span> <span class="kt">c</span><span class="p">(</span><span class="m">2</span><span class="p">,</span><span class="m">1</span><span class="p">),</span> 
		   standardize <span class="o">=</span> <span class="kc">FALSE</span><span class="p">,</span> <span class="c1">#plot Net benefit instead of standardized net benefit</span>
		   legend.position <span class="o">=</span> <span class="s">"topright"</span><span class="p">)</span> 
</pre></div>


<div class="figure">
<p><img src="img/dca-rmda-10.png" alt="dca-rmda-10.png"></p>
</div>
</div>
</div>

<div id="outline-container-sec-2-5" class="outline-3">
<h3 id="sec-2-5">Providing fitted risks from a previously specified model</h3>
<div class="outline-text-3" id="text-2-5">
<p>
skip
</p>
</div>
</div>

<div id="outline-container-sec-2-6" class="outline-3">
<h3 id="sec-2-6">Printing estimates</h3>
<div class="outline-text-3" id="text-2-6">
<div class="highlight"><pre><span></span>full.model <span class="o">&lt;-</span> decision_curve<span class="p">(</span>Cancer<span class="o">~</span>Age <span class="o">+</span> Female <span class="o">+</span> Smokes <span class="o">+</span> Marker1 <span class="o">+</span> Marker2<span class="p">,</span>
			    data <span class="o">=</span> dcaData<span class="p">,</span> 
			    thresholds <span class="o">=</span> <span class="kp">seq</span><span class="p">(</span><span class="m">.01</span><span class="p">,</span> <span class="m">.99</span><span class="p">,</span> by <span class="o">=</span> <span class="m">.05</span><span class="p">),</span>
			    bootstraps <span class="o">=</span> <span class="m">25</span><span class="p">,</span> policy <span class="o">=</span> <span class="s">"opt-out"</span><span class="p">)</span>
<span class="kp">summary</span><span class="p">(</span>full.model<span class="p">,</span> measure <span class="o">=</span> <span class="s">"NB"</span><span class="p">)</span> <span class="c1">#outputs standardized net benefit by default</span>
</pre></div>

<pre class="example">
Net Benefit (95% Confidence Intervals):
--------------------------------------------------------------------------------------------
   risk      cost:benefit     percent       All     Cancer ~ Age + Female + Smokes    None  
 threshold      ratio         low risk                   + Marker1 + Marker2                
----------- -------------- -------------- -------- -------------------------------- --------
   0.01          99:1           24.8         0                  -0.152                -11   
                            (13.8, 48.6)   (0, 0)           (-0.55, 0.392)                  

   0.06          47:3           60.2         0                  0.335                  -1   
                             (46.8, 71)    (0, 0)           (0.183, 0.61)                   

   0.11         89:11           70.2         0                   0.52                -0.091 
                            (64.2, 76.4)   (0, 0)           (0.377, 0.709)                  

   0.16          21:4           75.6         0                  0.618                 0.25  
                            (70.6, 80.8)   (0, 0)           (0.507, 0.733)                  

   0.21         79:21           79.6         0                  0.653                0.429  
                            (74.8, 85.2)   (0, 0)           (0.586, 0.723)                  

   0.26         37:13            84          0                  0.655                0.538  
                              (79, 89)     (0, 0)           (0.617, 0.763)                  

   0.31         69:31           86.2         0                  0.688                0.613  
                            (81.4, 91.8)   (0, 0)           (0.639, 0.783)                  

   0.36          16:9            89          0                  0.718                0.667  
                            (85.2, 92.8)   (0, 0)           (0.66, 0.811)                   

   0.41         59:41           92.4         0                  0.763                0.707  
                            (87.8, 94.6)   (0, 0)           (0.686, 0.81)                   

   0.46         27:23           93.8         0                  0.768                0.739  
                             (89, 97.2)    (0, 0)           (0.721, 0.816)                  

   0.51         49:51            95          0                  0.785                0.765  
                            (91.6, 97.6)   (0, 0)           (0.736, 0.829)                  

   0.56         11:14           96.2         0                  0.798                0.786  
                             (93, 98.4)    (0, 0)           (0.748, 0.846)                  

   0.61         39:61           96.8         0                  0.817                0.803  
                            (94.6, 98.6)   (0, 0)           (0.78, 0.857)                   

   0.66         17:33           97.2         0                  0.827                0.818  
                             (94.8, 99)    (0, 0)           (0.79, 0.861)                   

   0.71         29:71           97.8         0                  0.837                0.831  
                             (95.2, 99)    (0, 0)           (0.801, 0.873)                  

   0.76          6:19           98.4         0                  0.845                0.842  
                             (96, 99.4)    (0, 0)           (0.81, 0.879)                   

   0.81         19:81           98.8         0                  0.855                0.852  
                            (97.6, 100)    (0, 0)           (0.821, 0.884)                  

   0.86          7:43           99.2         0                  0.862                 0.86  
                            (97.8, 100)    (0, 0)           (0.829, 0.891)                  

   0.91          9:91           100          0                  0.868                0.868  
                            (98.8, 100)    (0, 0)           (0.837, 0.897)                  

   0.96          1:24           100          0                  0.875                0.875  
                            (99.8, 100)    (0, 0)           (0.846, 0.902)                  
--------------------------------------------------------------------------------------------
</pre>

<div class="highlight"><pre><span></span><span class="kp">head</span><span class="p">(</span>full.model<span class="o">$</span>derived.data<span class="p">)</span>
</pre></div>

<pre class="example">
  thresholds       FPR        FNR       TPR       TNR         NB        sNB  rho prob.high.risk prob.low.risk    DP nonDP
1       0.01 0.7227273 0.03333333 0.9666667 0.2772727 -0.1520000 -0.1727273 0.12          0.752         0.248 0.116 0.244
2       0.06 0.3340909 0.13333333 0.8666667 0.6659091  0.3353333  0.3810606 0.12          0.398         0.602 0.104 0.586
3       0.11 0.2250000 0.16666667 0.8333333 0.7750000  0.5201818  0.5911157 0.12          0.298         0.702 0.100 0.682
4       0.16 0.1659091 0.18333333 0.8166667 0.8340909  0.6185000  0.7028409 0.12          0.244         0.756 0.098 0.734
5       0.21 0.1295455 0.25000000 0.7500000 0.8704545  0.6531429  0.7422078 0.12          0.204         0.796 0.090 0.766
6       0.26 0.1000000 0.40000000 0.6000000 0.9000000  0.6553846  0.7447552 0.12          0.160         0.840 0.072 0.792
                                               model  FPR_lower FPR_upper  FNR_lower  FNR_upper TPR_lower TPR_upper TNR_lower
1 Cancer ~ Age + Female + Smokes + Marker1 + Marker2 0.46102450 0.8402778 0.00000000 0.06382979 0.9361702 1.0000000 0.1597222
2 Cancer ~ Age + Female + Smokes + Marker1 + Marker2 0.21603563 0.4745370 0.03703704 0.18032787 0.8196721 0.9629630 0.5254630
3 Cancer ~ Age + Female + Smokes + Marker1 + Marker2 0.15590200 0.2857143 0.05882353 0.25000000 0.7500000 0.9411765 0.7142857
4 Cancer ~ Age + Female + Smokes + Marker1 + Marker2 0.11358575 0.2018561 0.11764706 0.30645161 0.6935484 0.8823529 0.7981439
5 Cancer ~ Age + Female + Smokes + Marker1 + Marker2 0.09492274 0.1577726 0.14084507 0.40350877 0.5964912 0.8591549 0.8422274
6 Cancer ~ Age + Female + Smokes + Marker1 + Marker2 0.06401766 0.1252900 0.23943662 0.47169811 0.5283019 0.7605634 0.8747100
  TNR_upper   NB_lower  NB_upper  sNB_lower sNB_upper rho_lower rho_upper prob.high.risk_lower prob.high.risk_upper
1 0.5389755 -0.5500000 0.3920000 -0.6365741 0.4355556     0.094     0.148                0.514                0.862
2 0.7839644  0.1833333 0.6100000  0.2088079 0.6792873     0.094     0.148                0.290                0.532
3 0.8440980  0.3770909 0.7094545  0.4324437 0.7900385     0.094     0.148                0.236                0.358
4 0.8864143  0.5070000 0.7330000  0.5804795 0.8162584     0.094     0.148                0.192                0.294
5 0.9050773  0.5855238 0.7232381  0.6669891 0.8053876     0.094     0.148                0.148                0.252
6 0.9359823  0.6173846 0.7626154  0.7162235 0.8417388     0.094     0.148                0.110                0.210
  prob.low.risk_lower prob.low.risk_upper DP_lower DP_upper nonDP_lower nonDP_upper cost.benefit.ratio
1               0.138               0.486    0.088    0.144       0.138       0.484               99:1
2               0.468               0.710    0.080    0.132       0.454       0.704               47:3
3               0.642               0.764    0.074    0.124       0.620       0.758              89:11
4               0.706               0.808    0.070    0.124       0.684       0.796               21:4
5               0.748               0.852    0.060    0.124       0.722       0.820              79:21
6               0.790               0.890    0.052    0.108       0.750       0.848              37:13
</pre>
</div>
</div>

<div id="outline-container-sec-2-7" class="outline-3">
<h3 id="sec-2-7">Case-control data</h3>
<div class="outline-text-3" id="text-2-7">
<p>
If data is from a case-control study instead of an observational cohort, an estimate of the population level outcome prevalence is needed to calculate decision curves. Decision curves can be calculated by setting study.design = "case-control" and setting the population.prevalence. Once the decision<sub>curve</sub> is calculated, all other calls to the plot functions remain the same. Note that bootstrap sampling is done stratified by outcome status for these data.
</p>

<div class="highlight"><pre><span></span><span class="c1">#simulated case-control data with same variables as above</span>
data<span class="p">(</span>dcaData_cc<span class="p">)</span>

<span class="c1">#estimated from the population where the </span>
<span class="c1">#case-control sample comes from. </span>
population.rho <span class="o">=</span> <span class="m">0.11</span>

baseline.model_cc <span class="o">&lt;-</span> decision_curve<span class="p">(</span>Cancer<span class="o">~</span>Age <span class="o">+</span> Female <span class="o">+</span> Smokes<span class="p">,</span>
				    data <span class="o">=</span> dcaData_cc<span class="p">,</span> 
				    thresholds <span class="o">=</span> <span class="kp">seq</span><span class="p">(</span><span class="m">0</span><span class="p">,</span> <span class="m">.4</span><span class="p">,</span> by <span class="o">=</span> <span class="m">.01</span><span class="p">),</span>
				    bootstraps <span class="o">=</span> <span class="m">25</span><span class="p">,</span> 
				    study.design <span class="o">=</span> <span class="s">"case-control"</span><span class="p">,</span> 
				    population.prevalence <span class="o">=</span> population.rho<span class="p">)</span>

full.model_cc <span class="o">&lt;-</span> decision_curve<span class="p">(</span>Cancer<span class="o">~</span>Age <span class="o">+</span> Female <span class="o">+</span> Smokes <span class="o">+</span> Marker1 <span class="o">+</span> Marker2<span class="p">,</span>
				data <span class="o">=</span> dcaData_cc<span class="p">,</span> 
				thresholds <span class="o">=</span> <span class="kp">seq</span><span class="p">(</span><span class="m">0</span><span class="p">,</span> <span class="m">.4</span><span class="p">,</span> by <span class="o">=</span> <span class="m">.01</span><span class="p">),</span>
				bootstraps <span class="o">=</span> <span class="m">25</span><span class="p">,</span> 
				study.design <span class="o">=</span> <span class="s">"case-control"</span><span class="p">,</span> 
				population.prevalence <span class="o">=</span> population.rho<span class="p">)</span>


plot_decision_curve<span class="p">(</span> <span class="kt">list</span><span class="p">(</span>baseline.model_cc<span class="p">,</span> full.model_cc<span class="p">),</span> 
		   curve.names <span class="o">=</span> <span class="kt">c</span><span class="p">(</span><span class="s">"Baseline model"</span><span class="p">,</span> <span class="s">"Full model"</span><span class="p">),</span>
		   col <span class="o">=</span> <span class="kt">c</span><span class="p">(</span><span class="s">"blue"</span><span class="p">,</span> <span class="s">"red"</span><span class="p">),</span> 
		   lty <span class="o">=</span> <span class="kt">c</span><span class="p">(</span><span class="m">1</span><span class="p">,</span><span class="m">2</span><span class="p">),</span> 
		   lwd <span class="o">=</span> <span class="kt">c</span><span class="p">(</span><span class="m">3</span><span class="p">,</span><span class="m">2</span><span class="p">,</span> <span class="m">2</span><span class="p">,</span> <span class="m">1</span><span class="p">),</span> 
		   legend.position <span class="o">=</span> <span class="s">"bottomright"</span><span class="p">)</span> 
</pre></div>


<div class="figure">
<p><img src="img/dca-rmda-11.png" alt="dca-rmda-11.png"></p>
</div>
</div>
</div>

<div id="outline-container-sec-2-8" class="outline-3">
<h3 id="sec-2-8">Cross-validation</h3>
<div class="outline-text-3" id="text-2-8">
<p>
We provide a wrapper to perform k-fold cross-validation to obtain bias corrected decision curves. Once cv<sub>decision</sub><sub>curve</sub> is called, all plot and summary functions work the same as shown above for decision<sub>curve</sub> output. Confidence interval calculation is not available at this time for cross-validated curves.
</p>

<div class="highlight"><pre><span></span>full.model_cv <span class="o">&lt;-</span> cv_decision_curve<span class="p">(</span>Cancer<span class="o">~</span>Age <span class="o">+</span> Female <span class="o">+</span> Smokes <span class="o">+</span> Marker1 <span class="o">+</span> Marker2<span class="p">,</span>
				    data <span class="o">=</span> dcaData<span class="p">,</span>
				    folds <span class="o">=</span> <span class="m">5</span><span class="p">,</span> 
				    thresholds <span class="o">=</span> <span class="kp">seq</span><span class="p">(</span><span class="m">0</span><span class="p">,</span> <span class="m">.4</span><span class="p">,</span> by <span class="o">=</span> <span class="m">.01</span><span class="p">),</span> 
				   policy <span class="o">=</span> <span class="s">"opt-out"</span><span class="p">)</span>

full.model_apparent <span class="o">&lt;-</span> decision_curve<span class="p">(</span>Cancer<span class="o">~</span>Age <span class="o">+</span> Female <span class="o">+</span> Smokes <span class="o">+</span> Marker1 <span class="o">+</span> Marker2<span class="p">,</span>
				data <span class="o">=</span> dcaData<span class="p">,</span> 
				thresholds <span class="o">=</span> <span class="kp">seq</span><span class="p">(</span><span class="m">0</span><span class="p">,</span> <span class="m">.4</span><span class="p">,</span> by <span class="o">=</span> <span class="m">.01</span><span class="p">),</span>
				confidence.intervals <span class="o">=</span> <span class="s">'none'</span><span class="p">,</span> policy <span class="o">=</span> <span class="s">"opt-out"</span><span class="p">)</span>


plot_decision_curve<span class="p">(</span> <span class="kt">list</span><span class="p">(</span>full.model_apparent<span class="p">,</span> full.model_cv<span class="p">),</span> 
		   curve.names <span class="o">=</span> <span class="kt">c</span><span class="p">(</span><span class="s">"Apparent curve"</span><span class="p">,</span> <span class="s">"Cross-validated curve"</span><span class="p">),</span>
		   col <span class="o">=</span> <span class="kt">c</span><span class="p">(</span><span class="s">"red"</span><span class="p">,</span> <span class="s">"blue"</span><span class="p">),</span> 
		   lty <span class="o">=</span> <span class="kt">c</span><span class="p">(</span><span class="m">2</span><span class="p">,</span><span class="m">1</span><span class="p">),</span> 
		   lwd <span class="o">=</span> <span class="kt">c</span><span class="p">(</span><span class="m">3</span><span class="p">,</span><span class="m">2</span><span class="p">,</span> <span class="m">2</span><span class="p">,</span> <span class="m">1</span><span class="p">),</span> 
		   legend.position <span class="o">=</span> <span class="s">"bottomright"</span><span class="p">)</span> 
</pre></div>


<div class="figure">
<p><img src="img/dca-rmda-12.png" alt="dca-rmda-12.png"></p>
</div>
</div>
</div>
</div>


<div id="outline-container-sec-3" class="outline-2">
<h2 id="sec-3">decisioncurveanalysis.org</h2>
<div class="outline-text-2" id="text-3">
<p>
Diagnostic and prognostic models are typically evaluated with measures of accuracy that do not address clinical consequences. Decision-analytic techniques allow assessment of clinical outcomes but often require collection of additional information and may be cumbersome to apply to models that yield a continuous result. Decision curve analysis is a method for evaluating and comparing prediction models that incorporates clinical consequences, requires only the data set on which the models are tested, and can be applied to models that have either continuous or dichotomous results. This document will walk you through how to perform a decision curve analysis (DCA) in many settings, and how to interpret the resulting curves. In DCA prediction models are compared to two default strategies: 1) assume that all patients are test positive and therefore treat everyone, or 2) assume that all patients are test negative and offer treatment to no one. “Treatment” is considered in the widest possible sense, not only drugs, radiotherapy or surgery, but advice, further diagnostic procedures or more intensive monitoring. For more details on DCA, visit decisioncurveanalysis.org. You’ll find the original articles explaining the details of the DCA derivation along with other papers providing more details.
</p>
</div>

<div id="outline-container-sec-3-1" class="outline-3">
<h3 id="sec-3-1">Decision Curve Analysis for Binary Outcomes</h3>
<div class="outline-text-3" id="text-3-1">

<div class="figure">
<p><img src="img/Statistic%20analysis/screenshot_2018-02-03_22-15-28.png" alt="screenshot_2018-02-03_22-15-28.png"></p>
</div>
</div>

<div id="outline-container-sec-3-1-1" class="outline-4">
<h4 id="sec-3-1-1">Basic Data Set-up</h4>
<div class="outline-text-4" id="text-3-1-1">
<div class="highlight"><pre><span></span><span class="kn">source</span><span class="p">(</span><span class="s">"/home/lengyue/MEGA/Emacs-lengyue/Wiki-lengyue/Example/dca/dca.r"</span><span class="p">)</span>
data.set <span class="o">=</span> read.delim<span class="p">(</span><span class="s">"/home/lengyue/MEGA/Emacs-lengyue/Wiki-lengyue/Example/dca/dca.txt"</span><span class="p">,</span> header<span class="o">=</span><span class="kc">TRUE</span><span class="p">,</span> sep<span class="o">=</span><span class="s">"\t"</span><span class="p">)</span>
<span class="kn">attach</span><span class="p">(</span>data.set<span class="p">)</span>
<span class="kp">head</span><span class="p">(</span>data.set<span class="p">)</span>
</pre></div>

<pre class="example">
  patientid cancer dead  ttcancer   risk_group casecontrol      age famhistory    marker cancerpredmarker
1         1      0    0 3.0086860          low           0 64.03445          0 0.7763090        0.0372006
2         2      0    0 0.2491345         high           0 78.46741          0 0.2670864        0.5789074
3         3      0    0 1.5903580          low           0 64.14617          0 0.1696214        0.0215508
4         4      0    0 3.4566140          low           1 58.53482          0 0.0239958        0.0039097
5         5      0    0 3.3287420          low           0 63.99250          0 0.0709100        0.0187900
6         6      0    0 0.0488209 intermediate           1 65.74824          0 0.4275467        0.0426375
</pre>
</div>
</div>


<div id="outline-container-sec-3-1-2" class="outline-4">
<h4 id="sec-3-1-2">Univariate Decision Curve Analysis</h4>
<div class="outline-text-4" id="text-3-1-2">
<p>
First, we want to confirm family history of cancer is indeed associated with the biopsy result. Via logistic regression with cancer as the outcome, we can see that family history is related to biopsy outcome (OR 1.80; 95% CI 1.09, 2.99; p=0.022). The DCA can help us address the clinical utility of using family history to predict biopsy outcome.
</p>

<div class="highlight"><pre><span></span><span class="kp">summary</span><span class="p">(</span>glm<span class="p">(</span>cancer <span class="o">~</span> famhistory<span class="p">,</span> family<span class="o">=</span>binomial<span class="p">(</span>link<span class="o">=</span><span class="s">"logit"</span><span class="p">)))</span>
</pre></div>

<pre class="example">
Call:
glm(formula = cancer ~ famhistory, family = binomial(link = "logit"))

Deviance Residuals: 
    Min       1Q   Median       3Q      Max  
-0.6842  -0.5224  -0.5224  -0.5224   2.0294  

Coefficients:
            Estimate Std. Error z value Pr(&gt;|z|)
(Intercept)  -1.9227     0.1190 -16.163   &lt;2e-16
famhistory    0.5899     0.2585   2.282   0.0225

(Dispersion parameter for binomial family taken to be 1)

    Null deviance: 607.45  on 749  degrees of freedom
Residual deviance: 602.60  on 748  degrees of freedom
AIC: 606.6

Number of Fisher Scoring iterations: 4
</pre>


<div class="highlight"><pre><span></span>dca<span class="p">(</span>data<span class="o">=</span>data.set<span class="p">,</span> outcome<span class="o">=</span><span class="s">"cancer"</span><span class="p">,</span> predictors<span class="o">=</span><span class="s">"famhistory"</span><span class="p">)</span>
</pre></div>


<div class="figure">
<p><img src="img/dca-DCA-1.png" alt="dca-DCA-1.png"></p>
</div>

<p>
First, note that there are many threshold probabilities shown here that are not of interest. For example, it is unlikely that a patient would demand that they had at least a 50% risk of cancer before they would accept a biopsy. Let’s do the DCA again, this time restricting the output to threshold probabilities a more clinically reasonable range, between 0% and 35% with the xstop option.
</p>
<div class="highlight"><pre><span></span>dca<span class="p">(</span>data<span class="o">=</span>data.set<span class="p">,</span> outcome<span class="o">=</span><span class="s">"cancer"</span><span class="p">,</span> predictors<span class="o">=</span><span class="s">"famhistory"</span><span class="p">,</span> xstop<span class="o">=</span><span class="m">0.35</span><span class="p">)</span>
</pre></div>


<div class="figure">
<p><img src="img/dca-DCA-2.png" alt="dca-DCA-2.png"></p>
</div>

<p>
Now that the graph is showing a more reasonable range of threshold probabilities, let’s assess the clinical utility of family history alone. We can see here that although family history is significantly associated with biopsy outcome, it only adds value to a small range of threshold probabilities near 13% - 20%. If your personal threshold probability is 15% (i.e. you would undergo a biopsy if your probability of cancer was greater than 15%), then family history alone can be beneficial in making the decision to undergo biopsy. However, if your threshold probability is less than 13% or higher than 20%, then family history adds no more benefit than a biopsy all, or biopsy none scheme.
</p>
</div>
</div>

<div id="outline-container-sec-3-1-3" class="outline-4">
<h4 id="sec-3-1-3">Multivariable Decision Curve Analysis</h4>
<div class="outline-text-4" id="text-3-1-3">
<p>
We wanted to examine the value of a statistical model that incorporates family history, age, and the marker. First we will build the logistic regression model with all three variables, and second we would have saved out the predicted probability of having cancer based on the model. Note that in our example dataset, this variable actually already exists so it wouldn’t be necessary to create the predicted probabilities once again.
</p>

<p>
We now want to compare our different approaches to cancer detection: biopsying everyone, biopsying no-one, biopsying on the basis of family history, or biopsying on the basis of a multivariable statistical model including the marker, age and family history of cancer.
</p>
<div class="highlight"><pre><span></span><span class="c1">#run the multivariable model</span>
model <span class="o">=</span> glm<span class="p">(</span>cancer <span class="o">~</span> marker <span class="o">+</span> age <span class="o">+</span> famhistory<span class="p">,</span> family<span class="o">=</span>binomial<span class="p">(</span>link<span class="o">=</span><span class="s">"logit"</span><span class="p">))</span>
<span class="c1">#save out predictions in the form of probabilities</span>
data.set<span class="o">$</span>cancerpredmarker <span class="o">=</span> predict<span class="p">(</span>model<span class="p">,</span> type<span class="o">=</span><span class="s">"response"</span><span class="p">)</span>

dca<span class="p">(</span>data<span class="o">=</span>data.set<span class="p">,</span> outcome<span class="o">=</span><span class="s">"cancer"</span><span class="p">,</span> predictors<span class="o">=</span><span class="kt">c</span><span class="p">(</span><span class="s">"cancerpredmarker"</span><span class="p">,</span><span class="s">"famhistory"</span><span class="p">),</span> xstop<span class="o">=</span><span class="m">0.35</span><span class="p">)</span>
</pre></div>


<div class="figure">
<p><img src="img/dca-DCA-3.png" alt="dca-DCA-3.png"></p>
</div>

<p>
Decision curve analysis can incorporate joint or conditional testing. All that is required is that appropriate variables are calculated from the data set; decision curves are then calculated as normal. First we would create the variables to represent our joint and conditional approach. For our example, let us use 0.15 as the cutoff probability level for patients who had their marker measured and should be biopsied.
</p>

<div class="highlight"><pre><span></span><span class="c1">#Create a variable for the strategy of treating only high risk patients</span>
<span class="c1">#This will be 1 for treat and 0 for dont treat</span>
data.set<span class="o">$</span>high_risk <span class="o">=</span> <span class="kp">ifelse</span><span class="p">(</span>risk_group<span class="o">==</span><span class="s">"high"</span><span class="p">,</span> <span class="m">1</span><span class="p">,</span> <span class="m">0</span><span class="p">)</span>
<span class="c1">#Treat based on Joint Approach</span>
data.set<span class="o">$</span>joint <span class="o">=</span> <span class="kp">ifelse</span><span class="p">(</span>risk_group<span class="o">==</span><span class="s">"high"</span> <span class="o">|</span> cancerpredmarker <span class="o">&gt;</span> <span class="m">0.15</span><span class="p">,</span> <span class="m">1</span><span class="p">,</span> <span class="m">0</span><span class="p">)</span>
<span class="c1">#Treat based on Conditional Approach</span>
data.set<span class="o">$</span>conditional <span class="o">=</span> <span class="kp">ifelse</span><span class="p">(</span>risk_group<span class="o">==</span><span class="s">"high"</span> <span class="o">|</span> <span class="p">(</span>risk_group<span class="o">==</span><span class="s">"intermediate"</span> <span class="o">&amp;</span> cancerpredmarker <span class="o">&gt;</span> <span class="m">0.15</span><span class="p">),</span> <span class="m">1</span><span class="p">,</span> <span class="m">0</span><span class="p">)</span>

<span class="c1">#Run decision curve analysis</span>
dca<span class="p">(</span>data<span class="o">=</span>data.set<span class="p">,</span> outcome<span class="o">=</span><span class="s">"cancer"</span><span class="p">,</span> predictors<span class="o">=</span><span class="kt">c</span><span class="p">(</span><span class="s">"high_risk"</span><span class="p">,</span> <span class="s">"joint"</span><span class="p">,</span> 
<span class="s">"conditional"</span><span class="p">),</span> xstop<span class="o">=</span><span class="m">0.35</span><span class="p">)</span>
</pre></div>


<div class="figure">
<p><img src="img/dca-DCA-4.png" alt="dca-DCA-4.png"></p>
</div>
</div>
</div>
</div>

<div id="outline-container-sec-3-2" class="outline-3">
<h3 id="sec-3-2">Decision Curve Analysis for Survival Outcomes</h3>
<div class="outline-text-3" id="text-3-2">

<div class="figure">
<p><img src="img/Statistic%20analysis/screenshot_2018-02-04_09-21-45.png" alt="screenshot_2018-02-04_09-21-45.png"></p>
</div>

<div class="highlight"><pre><span></span><span class="kn">source</span><span class="p">(</span><span class="s">"/home/lengyue/MEGA/Emacs-lengyue/Wiki-lengyue/Example/dca/stdca.R"</span><span class="p">)</span>
data.set <span class="o">=</span> read.delim<span class="p">(</span><span class="s">"/home/lengyue/MEGA/Emacs-lengyue/Wiki-lengyue/Example/dca/dca.txt"</span><span class="p">,</span> header<span class="o">=</span><span class="kc">TRUE</span><span class="p">,</span> sep<span class="o">=</span><span class="s">"\t"</span><span class="p">)</span>
<span class="kn">library</span><span class="p">(</span>survival<span class="p">)</span>
Srv <span class="o">=</span> Surv<span class="p">(</span>data.set<span class="o">$</span>ttcancer<span class="p">,</span> data.set<span class="o">$</span>cancer<span class="p">)</span>
<span class="kp">summary</span><span class="p">(</span>Srv<span class="p">)</span>
</pre></div>

<pre class="example">
     time              status    
Min.   :0.000512   Min.   :0.00  
1st Qu.:0.269994   1st Qu.:0.00  
Median :0.584479   Median :0.00  
Mean   :0.852950   Mean   :0.14  
3rd Qu.:1.176930   3rd Qu.:0.00  
Max.   :5.284884   Max.   :1.00
</pre>


<div class="figure">
<p><img src="img/Statistic%20analysis/screenshot_2018-02-04_09-37-41.png" alt="screenshot_2018-02-04_09-37-41.png"></p>
</div>

<div class="highlight"><pre><span></span><span class="c1">#Run the cox model</span>
coxmod <span class="o">=</span> coxph<span class="p">(</span>Srv <span class="o">~</span> age <span class="o">+</span> famhistory <span class="o">+</span> marker<span class="p">,</span> data<span class="o">=</span>data.set<span class="p">)</span>
<span class="c1">#the probability of failure is calculated by subtracting the probability of </span>
<span class="c1">#survival from 1. </span>
data.set<span class="o">$</span>pr_failure18 <span class="o">=</span> <span class="kt">c</span><span class="p">(</span><span class="m">1</span><span class="o">-</span> <span class="p">(</span><span class="kp">summary</span><span class="p">(</span>survfit<span class="p">(</span>coxmod<span class="p">,</span> newdata<span class="o">=</span>data.set<span class="p">),</span> times<span class="o">=</span><span class="m">1.5</span><span class="p">)</span><span class="o">$</span>surv<span class="p">))</span>

<span class="c1">#Run the decision curve analysis (with a smoother)</span>
stdca<span class="p">(</span>data<span class="o">=</span>data.set<span class="p">,</span> outcome<span class="o">=</span><span class="s">"cancer"</span><span class="p">,</span> ttoutcome<span class="o">=</span><span class="s">"ttcancer"</span><span class="p">,</span> timepoint<span class="o">=</span><span class="m">1.5</span><span class="p">,</span> predictors<span class="o">=</span><span class="s">"pr_failure18"</span><span class="p">,</span> xstop<span class="o">=</span><span class="m">0.5</span><span class="p">,</span> smooth<span class="o">=</span><span class="kc">TRUE</span><span class="p">)</span>
</pre></div>


<div class="figure">
<p><img src="img/dca-DCA-5.png" alt="dca-DCA-5.png"></p>
</div>
</div>
</div>

<div id="outline-container-sec-3-3" class="outline-3">
<h3 id="sec-3-3">Assessing Clinical Utility in a Case-Control Design</h3>
<div class="outline-text-3" id="text-3-3">
<div class="highlight"><pre><span></span><span class="c1">#Use only the data from the case control study</span>
casecontrol <span class="o">=</span> <span class="kp">subset</span><span class="p">(</span>data.set<span class="p">,</span> casecontrol <span class="o">==</span><span class="m">1</span><span class="p">)</span>
<span class="c1">#Create the model</span>
model <span class="o">=</span> glm<span class="p">(</span>cancer<span class="o">~</span> age <span class="o">+</span> famhistory<span class="p">,</span> family<span class="o">=</span>binomial<span class="p">(</span>link<span class="o">=</span><span class="s">"logit"</span><span class="p">),</span> 
data<span class="o">=</span>casecontrol<span class="p">)</span>
<span class="c1">#Save out the linear predictor</span>
xb <span class="o">=</span> predict<span class="p">(</span>model<span class="p">)</span>

<span class="c1">#The true risk is stored in a scalar</span>
true <span class="o">=</span> <span class="m">0.05</span>
<span class="c1">#The observed risk, the mean of our data, is stored in a scalar</span>
design <span class="o">=</span> <span class="kp">mean</span><span class="p">(</span>casecontrol<span class="o">$</span>cancer<span class="p">)</span>
<span class="c1">#The Bayes factor is stored in a scalar</span>
Bayes <span class="o">=</span> <span class="kp">log</span><span class="p">((</span>true<span class="o">/</span><span class="p">(</span><span class="m">1</span><span class="o">-</span>true<span class="p">))</span><span class="o">/</span><span class="p">(</span>design<span class="o">/</span><span class="p">(</span><span class="m">1</span><span class="o">-</span>design<span class="p">)))</span>
<span class="c1">#We add the Bayes factor to the linear predictor</span>
xb <span class="o">=</span> xb<span class="o">+</span>Bayes

<span class="c1">#Convert to a probability</span>
casecontrol<span class="o">$</span>phat <span class="o">=</span> <span class="kp">exp</span><span class="p">(</span>xb<span class="p">)</span><span class="o">/</span><span class="p">(</span><span class="m">1</span><span class="o">+</span><span class="kp">exp</span><span class="p">(</span>xb<span class="p">))</span>
<span class="c1">#Run the decision curve</span>
dca<span class="p">(</span>data<span class="o">=</span>casecontrol<span class="p">,</span> outcome<span class="o">=</span><span class="s">"phat"</span><span class="p">,</span> predictors<span class="o">=</span><span class="s">"phat"</span><span class="p">,</span> xstop<span class="o">=</span><span class="m">0.35</span><span class="p">)</span>
</pre></div>


<div class="figure">
<p><img src="img/dca-DCA-6.png" alt="dca-DCA-6.png"></p>
</div>
</div>
</div>
</div>

<div id="outline-container-sec-4" class="outline-2">
<h2 id="sec-4">Creative Commons licensing</h2>
<div class="outline-text-2" id="text-4">
<blockquote>
<p>
TITLE: Decision curve anaysis (决策曲线分析)<br>
AUTHOR: lengyueyang <br>
DATE: 2018-02-04 09:56:36 UTC+08:00<br>
UPDATED: <br>
LICENSE: The blog is licensed under a <a href="http://creativecommons.org/licenses/by-sa/4.0/">Creative Commons Attribution-NonCommercial-ShareAlike 4.0 International License</a>, commercial use is not allowed, for any reprint, please indicate address and signature.
<img src="https://i.creativecommons.org/l/by-nc-sa/4.0/88x31.png" alt="88x31.png"></p>
</blockquote>
</div>
</div>
    </div>
    <aside class="postpromonav"><nav><ul itemprop="keywords" class="tags">
<li><a class="tag p-category" href="../categories/dca.html" rel="tag">DCA</a></li>
        </ul>
<ul class="pager hidden-print">
<li class="previous">
                <a href="Nomogram-rms.html" rel="prev" title="Nomograph 图制作 (一) - 用 rms 绘制 nomogram">Previous post</a>
            </li>
            <li class="next">
                <a href="../Life/gentoo-install.html" rel="next" title="Gentoo 系统 - (一) 系统配置与安装">Next post</a>
            </li>
        </ul></nav></aside><section class="comments hidden-print"><h2>Comments</h2>
        
        
        <div id="disqus_thread"></div>
        <script>
        var disqus_shortname ="lengyueyang",
            disqus_url="https://lengyueyang.github.io/Research/decision-curve-anaysis.html",
        disqus_title="Decision curve anaysis (\u51b3\u7b56\u66f2\u7ebf\u5206\u6790)",
        disqus_identifier="cache/posts/Research/decision-curve-anaysis.html",
        disqus_config = function () {
            this.language = "en";
        };
        (function() {
            var dsq = document.createElement('script'); dsq.async = true;
            dsq.src = 'https://' + disqus_shortname + '.disqus.com/embed.js';
            (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
        })();
    </script><noscript>Please enable JavaScript to view the <a href="https://disqus.com/?ref_noscript" rel="nofollow">comments powered by Disqus.</a>
</noscript>
    <a href="https://disqus.com" class="dsq-brlink" rel="nofollow">Comments powered by <span class="logo-disqus">Disqus</span></a>


        </section></article><script>var disqus_shortname="lengyueyang";(function(){var a=document.createElement("script");a.async=true;a.src="https://"+disqus_shortname+".disqus.com/count.js";(document.getElementsByTagName("head")[0]||document.getElementsByTagName("body")[0]).appendChild(a)}());</script>
</div>
        <!--End of body content-->

        <footer id="footer">
            Contents © 2018         <a href="mailto:maoxiaowei1988@qq.com">Lengyueyang</a> - Powered by         <a href="https://getnikola.com" rel="nofollow">Nikola</a> and <a href="#" https: rel="nofollow">Org-mode</a>       
<a rel="license" href="https://creativecommons.org/licenses/by-nc-sa/4.0/">
<img alt="Creative Commons License BY-NC-SA" src="https://i.creativecommons.org/l/by-nc-sa/4.0/80x15.png"></a>
            
        </footer>
</div>
</div>


            <script src="../assets/js/all-nocdn.js"></script><script>$('a.image-reference:not(.islink) img:not(.islink)').parent().colorbox({rel:"gal",maxWidth:"100%",maxHeight:"100%",scalePhotos:true});</script><!-- fancy dates --><script>
    moment.locale("en");
    fancydates(0, "YYYY-MM-DD HH:mm");
    </script><!-- end fancy dates -->
</body>
</html>
